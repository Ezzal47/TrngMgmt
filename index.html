<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F-35 Training Management System</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- QRCode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e2a5a;
            --primary-light: #3b5998;
            --secondary: #64748b;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Login Screen */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .auth-card {
            background: var(--surface);
            border-radius: 0.75rem;
            padding: 2.5rem;
            max-width: 24rem;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--surface);
            transition: all 0.15s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            line-height: 1.25rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--background);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 0.375rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
        }

        /* Main Application */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: block;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Navigation */
        .nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-list {
            display: flex;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: block;
            padding: 1rem 1.25rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .nav-link:hover {
            color: var(--text-primary);
        }

        .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Content */
        .content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: #fafbfc;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: #fafbfc;
        }

        /* Grid System */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* Progress Bar */
        .progress {
            height: 0.5rem;
            background: var(--border);
            border-radius: 0.25rem;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Checklist */
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 0.875rem;
            background: var(--background);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .checklist-icon {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            margin-right: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
        }

        .checklist-icon.complete {
            background: var(--success);
        }

        .checklist-icon.pending {
            background: var(--warning);
        }

        .checklist-label {
            flex: 1;
            font-size: 0.875rem;
        }

        /* Documents Grid */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .document-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .document-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .document-card.completed {
            border-color: var(--success);
            background: #f0fdf4;
        }

        .document-status {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: var(--warning);
        }

        .document-status.complete {
            background: var(--success);
        }

        .document-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .document-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .document-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Signature Canvas */
        .signature-container {
            border: 2px dashed var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            background: white;
            margin: 1rem 0;
        }

        #signatureCanvas {
            display: block;
            width: 100%;
            max-width: 600px;
            height: 200px;
            margin: 0 auto;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Room Assignment */
        .room-info {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .room-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .room-detail {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.375rem;
        }

        .room-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .room-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* QR Code */
        .qr-container {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            display: inline-block;
            box-shadow: var(--shadow-md);
        }

        /* Alerts */
        .alert {
            padding: 0.875rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
        }

        .alert-success {
            background: #dcfce7;
            border-color: #86efac;
            color: #15803d;
        }

        .alert-warning {
            background: #fef3c7;
            border-color: #fde047;
            color: #a16207;
        }

        .alert-danger {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #b91c1c;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 0.5rem;
            max-width: 32rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Loading */
        .spinner {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr;
            }

            .nav-list {
                padding: 0;
            }

            .nav-link {
                padding: 0.875rem 1rem;
                font-size: 0.8rem;
            }

            .documents-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .room-details {
                grid-template-columns: 1fr;
            }

            .auth-card {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .content {
                padding: 1rem;
            }

            .card-body {
                padding: 1rem;
            }

            .btn {
                font-size: 0.8rem;
                padding: 0.5rem 1rem;
            }
        }

        /* Print */
        @media print {
            .header,
            .nav,
            .btn,
            .signature-controls {
                display: none !important;
            }

            .card {
                page-break-inside: avoid;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="auth-container" id="authScreen">
        <div class="auth-card">
            <div class="auth-header">
                <h1 class="auth-title">F-35 TMS</h1>
                <p class="auth-subtitle">Training Management System</p>
            </div>
            
            <form onsubmit="event.preventDefault(); login();">
                <div class="form-group">
                    <label for="accessCode">Codice di Accesso</label>
                    <input type="text" 
                           id="accessCode" 
                           placeholder="Inserisci il codice ricevuto"
                           style="text-transform: uppercase; letter-spacing: 1px;"
                           required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    Accedi al Sistema
                </button>
            </form>
            
            <p class="text-center text-sm mt-4" style="color: var(--text-secondary);">
                Per ottenere un codice di accesso, contatta il Liaison Officer
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appScreen">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    F-35 Training Management
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-name" id="userName">---</div>
                        <div class="user-role" id="userRole">---</div>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="logout()">
                        Esci
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-list">
                <div class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('dashboard', this)">Dashboard</a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('personal', this)">Dati Personali</a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('signature', this)">Firma Digitale</a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('documents', this)">Documenti</a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('room', this)">Alloggio</a>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Dashboard Section -->
            <section class="section active" id="dashboard">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Stato Registrazione</h2>
                    </div>
                    <div class="card-body">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-label">
                            <span>Progresso</span>
                            <span id="progressText">0%</span>
                        </div>
                        
                        <h3 class="font-semibold mb-3 mt-4">Checklist Completamento</h3>
                        <div id="checklistContainer">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Azioni Richieste</h2>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-2" style="gap: 1rem;">
                            <button class="btn btn-primary" onclick="showSection('personal', document.querySelector('.nav-link[onclick*=personal]'))">
                                Completa Dati Personali
                            </button>
                            <button class="btn btn-primary" onclick="showSection('signature', document.querySelector('.nav-link[onclick*=signature]'))">
                                Configura Firma
                            </button>
                            <button class="btn btn-primary" onclick="showSection('documents', document.querySelector('.nav-link[onclick*=documents]'))">
                                Compila Documenti
                            </button>
                            <button class="btn btn-primary" onclick="showSection('room', document.querySelector('.nav-link[onclick*=room]'))">
                                Verifica Alloggio
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Personal Data Section -->
            <section class="section" id="personal">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Dati Personali</h2>
                        <p class="card-subtitle">Compila tutti i campi richiesti per procedere con la registrazione</p>
                    </div>
                    <div class="card-body">
                        <form id="personalForm" onsubmit="event.preventDefault(); savePersonalData();">
                            <div class="grid grid-cols-3">
                                <div class="form-group">
                                    <label for="rank">Grado *</label>
                                    <select id="rank" required>
                                        <option value="">Seleziona...</option>
                                        <option value="Ten">Tenente</option>
                                        <option value="Cap">Capitano</option>
                                        <option value="Magg">Maggiore</option>
                                        <option value="Ten Col">Ten. Colonnello</option>
                                        <option value="Col">Colonnello</option>
                                        <option value="Gen">Generale</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="firstName">Nome *</label>
                                    <input type="text" id="firstName" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="lastName">Cognome *</label>
                                    <input type="text" id="lastName" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="fiscalCode">Codice Fiscale *</label>
                                    <input type="text" id="fiscalCode" maxlength="16" pattern="[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]" style="text-transform: uppercase;" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="birthDate">Data di Nascita *</label>
                                    <input type="date" id="birthDate" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="birthPlace">Luogo di Nascita *</label>
                                    <input type="text" id="birthPlace" placeholder="Città (Provincia)" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="nationality">Nazionalità *</label>
                                    <input type="text" id="nationality" value="Italiana" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email *</label>
                                    <input type="email" id="email" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Telefono *</label>
                                    <input type="tel" id="phone" placeholder="+39 xxx xxx xxxx" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="service">Forza Armata *</label>
                                    <select id="service" required>
                                        <option value="">Seleziona...</option>
                                        <option value="Aeronautica Militare">Aeronautica Militare</option>
                                        <option value="Marina Militare">Marina Militare</option>
                                        <option value="Esercito">Esercito</option>
                                        <option value="Carabinieri">Carabinieri</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="unit">Reparto di Appartenenza *</label>
                                    <input type="text" id="unit" placeholder="es. 32° Stormo" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="serviceNumber">Matricola</label>
                                    <input type="text" id="serviceNumber">
                                </div>
                                
                                <div class="form-group">
                                    <label for="course">Corso *</label>
                                    <select id="course" required>
                                        <option value="">Seleziona...</option>
                                        <option value="Pilot Training">Pilot Training</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Avionics">Avionics</option>
                                        <option value="Weapons Systems">Weapons Systems</option>
                                        <option value="Instructor">Instructor</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="clearance">Livello Nulla Osta *</label>
                                    <select id="clearance" required>
                                        <option value="">Seleziona...</option>
                                        <option value="NATO COSMIC">NATO COSMIC</option>
                                        <option value="NATO SECRET">NATO SECRET</option>
                                        <option value="NATO CONFIDENTIAL">NATO CONFIDENTIAL</option>
                                        <option value="NATO RESTRICTED">NATO RESTRICTED</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="arrivalDate">Data Arrivo *</label>
                                    <input type="date" id="arrivalDate" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="departureDate">Data Partenza *</label>
                                    <input type="date" id="departureDate" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="passportNumber">Numero Passaporto</label>
                                    <input type="text" id="passportNumber">
                                </div>
                                
                                <div class="form-group">
                                    <label for="passportExpiry">Scadenza Passaporto</label>
                                    <input type="date" id="passportExpiry">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="emergencyContact">Contatto di Emergenza *</label>
                                <input type="text" id="emergencyContact" placeholder="Nome e numero di telefono" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="medicalConditions">Condizioni Mediche / Allergie</label>
                                <textarea id="medicalConditions" rows="3" placeholder="Indicare eventuali condizioni mediche, allergie o necessità particolari"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="dietaryRestrictions">Restrizioni Alimentari</label>
                                <input type="text" id="dietaryRestrictions" placeholder="es. Vegetariano, senza glutine, etc.">
                            </div>
                            
                            <div class="card-footer" style="margin: -1.5rem; margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-primary">
                                    Salva Dati Personali
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Signature Section -->
            <section class="section" id="signature">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Firma Digitale</h2>
                        <p class="card-subtitle">Configura la tua firma per i documenti ufficiali</p>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            Puoi caricare una foto della tua firma autografa oppure disegnarla direttamente sul dispositivo
                        </div>
                        
                        <div class="text-center mb-4">
                            <input type="file" id="signatureFile" accept="image/*" style="display: none;" onchange="uploadSignature(event)">
                            <button class="btn btn-primary" onclick="document.getElementById('signatureFile').click()">
                                Carica Foto Firma
                            </button>
                        </div>
                        
                        <div class="signature-container">
                            <canvas id="signatureCanvas"></canvas>
                            <div class="signature-controls">
                                <button class="btn btn-outline" onclick="clearSignature()">Pulisci</button>
                                <button class="btn btn-primary" onclick="saveSignature()">Salva Firma</button>
                            </div>
                        </div>
                        
                        <div id="savedSignature" style="display: none;" class="mt-4">
                            <div class="alert alert-success">
                                Firma salvata con successo
                            </div>
                            <div class="text-center">
                                <img id="signatureImage" style="max-width: 100%; border: 1px solid var(--border); border-radius: 0.375rem; padding: 1rem; background: white;">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Documents Section -->
            <section class="section" id="documents">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Documenti da Compilare</h2>
                        <p class="card-subtitle">Clicca su ogni documento per compilarlo. I dati già inseriti verranno precompilati automaticamente.</p>
                    </div>
                    <div class="card-body">
                        <div class="documents-grid" id="documentsGrid">
                            <!-- Populated by JS -->
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-success btn-lg" onclick="submitAllDocuments()">
                                Firma e Invia Tutti i Documenti
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Room Section -->
            <section class="section" id="room">
                <div id="noRoom">
                    <div class="card">
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <strong>Alloggio non ancora assegnato</strong><br>
                                L'alloggio ti verrà assegnato dopo il completamento della registrazione. Riceverai una notifica quando sarà disponibile.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="roomAssigned" style="display: none;">
                    <div class="room-info">
                        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Alloggio Assegnato</h2>
                        
                        <div class="room-details">
                            <div class="room-detail">
                                <div class="room-label">Building</div>
                                <div class="room-value" id="roomBuilding">--</div>
                            </div>
                            <div class="room-detail">
                                <div class="room-label">Stanza</div>
                                <div class="room-value" id="roomNumber">--</div>
                            </div>
                            <div class="room-detail">
                                <div class="room-label">Letto</div>
                                <div class="room-value" id="roomBed">--</div>
                            </div>
                            <div class="room-detail">
                                <div class="room-label">Check-in</div>
                                <div class="room-value" id="roomCheckin">--</div>
                            </div>
                            <div class="room-detail">
                                <div class="room-label">Check-out</div>
                                <div class="room-value" id="roomCheckout">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-body">
                            <h3 class="font-semibold mb-3">Indirizzo e Indicazioni</h3>
                            <p id="roomAddress" class="mb-3">--</p>
                            <button class="btn btn-primary" onclick="openMap()">
                                Apri in Google Maps
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-body text-center">
                            <h3 class="font-semibold mb-3">QR Code Check-in</h3>
                            <div class="qr-container" style="display: inline-block;">
                                <div id="qrcode"></div>
                            </div>
                            <p class="text-sm text-secondary mt-3">
                                Presenta questo codice al check-in
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Document Modal -->
    <div class="modal" id="documentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Compila Documento</h3>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveDocument()">Salva e Firma</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        (function() {
            // Will be initialized with config from admin
        })();

        // State Management
        let userState = {
            accessCode: null,
            userData: {},
            signature: null,
            documents: {},
            room: null
        };

        let sharedConfig = {};
        let currentDocument = null;

        // Initialize
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                document.getElementById('accessCode').value = code;
            }
            
            const savedSession = sessionStorage.getItem('f35_session');
            if (savedSession) {
                userState = JSON.parse(savedSession);
                showApp();
            }
        });

        // Authentication
        function login() {
            const code = document.getElementById('accessCode').value.toUpperCase().trim();
            
            if (!code) {
                alert('Inserisci il codice di accesso');
                return;
            }
            
            const adminState = JSON.parse(localStorage.getItem('f35_admin_state') || '{}');
            const accessCode = adminState.accessCodes?.find(ac => ac.code === code);
            
            if (!accessCode) {
                alert('Codice non valido');
                return;
            }
            
            userState.accessCode = code;
            if (accessCode.userData) {
                userState.userData = accessCode.userData;
                userState.signature = accessCode.userData.signature;
                userState.documents = accessCode.userData.documents || {};
            }
            
            const room = adminState.rooms?.find(r => r.userId === accessCode.userId);
            if (room) {
                userState.room = room;
            }
            
            sessionStorage.setItem('f35_session', JSON.stringify(userState));
            
            const shared = localStorage.getItem('f35_shared_data');
            if (shared) {
                sharedConfig = JSON.parse(shared);
                if (sharedConfig.config?.publicKey) {
                    emailjs.init(sharedConfig.config.publicKey);
                }
            }
            
            showApp();
        }

        function logout() {
            sessionStorage.removeItem('f35_session');
            location.reload();
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').classList.add('active');
            updateUI();
        }

        // Navigation
        function showSection(sectionId, linkElement) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (linkElement) linkElement.classList.add('active');
        }

        // Save Personal Data
        function savePersonalData() {
            const fields = [
                'rank', 'firstName', 'lastName', 'fiscalCode', 'birthDate', 'birthPlace',
                'nationality', 'email', 'phone', 'service', 'unit', 'serviceNumber',
                'course', 'clearance', 'arrivalDate', 'departureDate', 'passportNumber',
                'passportExpiry', 'emergencyContact', 'medicalConditions', 'dietaryRestrictions'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    userState.userData[field] = element.value;
                }
            });
            
            userState.userData.lastUpdated = new Date().toISOString();
            updateAdminState();
            
            alert('Dati salvati con successo');
            updateUI();
        }

        // Signature Handling
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas?.getContext('2d');
        let isDrawing = false;

        if (canvas) {
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveSignature() {
            userState.signature = canvas.toDataURL();
            userState.userData.signature = userState.signature;
            updateAdminState();
            
            document.getElementById('savedSignature').style.display = 'block';
            document.getElementById('signatureImage').src = userState.signature;
            
            alert('Firma salvata con successo');
            updateUI();
        }

        function uploadSignature(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                userState.signature = e.target.result;
                userState.userData.signature = userState.signature;
                updateAdminState();
                
                document.getElementById('savedSignature').style.display = 'block';
                document.getElementById('signatureImage').src = userState.signature;
                
                alert('Firma caricata con successo');
                updateUI();
            };
            reader.readAsDataURL(file);
        }

        // Documents
        function updateDocuments() {
            const container = document.getElementById('documentsGrid');
            const docs = sharedConfig.documents || [
                { code: 'BCBS', name: 'BCBS Form', icon: 'BCBS', description: 'Modulo assicurazione sanitaria' },
                { code: 'LIABILITY', name: 'Responsabilità', icon: 'LIAB', description: 'Dichiarazione di responsabilità' },
                { code: 'SECURITY', name: 'Security', icon: 'SEC', description: 'Briefing sicurezza' },
                { code: 'HOUSING', name: 'Housing', icon: 'HOUS', description: 'Contratto alloggio' },
                { code: 'VEHICLE', name: 'Vehicle', icon: 'VEH', description: 'Registrazione veicolo' },
                { code: 'MEDICAL', name: 'Medical', icon: 'MED', description: 'Informazioni mediche' }
            ];
            
            container.innerHTML = docs.map(doc => `
                <div class="document-card ${userState.documents[doc.code] ? 'completed' : ''}" onclick="openDocument('${doc.code}')">
                    <span class="document-status ${userState.documents[doc.code] ? 'complete' : ''}"></span>
                    <div class="document-icon">${doc.icon}</div>
                    <div class="document-title">${doc.name}</div>
                    <div class="document-description">${doc.description}</div>
                </div>
            `).join('');
        }

        function openDocument(docCode) {
            if (!userState.userData.email) {
                alert('Completa prima i dati personali');
                showSection('personal', document.querySelector('.nav-link[onclick*=personal]'));
                return;
            }
            
            currentDocument = docCode;
            const modal = document.getElementById('documentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const doc = (sharedConfig.documents || []).find(d => d.code === docCode) || 
                       { name: docCode, template: '' };
            
            modalTitle.textContent = `Compila: ${doc.name}`;
            
            // Pre-compile with user data
            let formHtml = `
                <div class="alert alert-info mb-3">
                    I dati già inseriti sono stati precompilati. Verifica e modifica se necessario.
                </div>
            `;
            
            // Add document-specific fields based on type
            if (docCode === 'BCBS') {
                formHtml += `
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" value="${userState.userData.rank || ''} ${userState.userData.firstName || ''} ${userState.userData.lastName || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Codice Fiscale</label>
                        <input type="text" value="${userState.userData.fiscalCode || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Data di Nascita</label>
                        <input type="text" value="${userState.userData.birthDate || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Tipo Copertura</label>
                        <select class="doc-field" id="doc-coverage">
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Condizioni Preesistenti</label>
                        <textarea class="doc-field" id="doc-conditions">${userState.userData.medicalConditions || 'Nessuna'}</textarea>
                    </div>
                `;
            } else if (docCode === 'LIABILITY') {
                formHtml += `
                    <div class="alert alert-warning mb-3">
                        <strong>Dichiarazione di Responsabilità</strong><br>
                        Con la firma di questo documento, dichiaro di assumermi piena responsabilità per eventuali danni a persone o cose durante il periodo di training.
                    </div>
                    <div class="form-group">
                        <label>Sottoscritto/a</label>
                        <input type="text" value="${userState.userData.rank || ''} ${userState.userData.firstName || ''} ${userState.userData.lastName || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Nato/a a</label>
                        <input type="text" value="${userState.userData.birthPlace || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Il</label>
                        <input type="text" value="${userState.userData.birthDate || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" required> Accetto i termini e le condizioni
                        </label>
                    </div>
                `;
            } else if (docCode === 'HOUSING') {
                formHtml += `
                    <div class="form-group">
                        <label>Richiedente</label>
                        <input type="text" value="${userState.userData.rank || ''} ${userState.userData.firstName || ''} ${userState.userData.lastName || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Periodo</label>
                        <input type="text" value="Dal ${userState.userData.arrivalDate || ''} al ${userState.userData.departureDate || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Tipo Alloggio Preferito</label>
                        <select class="doc-field" id="doc-housing-type">
                            <option value="single">Stanza Singola</option>
                            <option value="shared">Stanza Condivisa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Note Speciali</label>
                        <textarea class="doc-field" id="doc-housing-notes">${userState.userData.dietaryRestrictions || ''}</textarea>
                    </div>
                `;
            } else {
                // Generic template
                formHtml += `
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" value="${userState.userData.rank || ''} ${userState.userData.firstName || ''} ${userState.userData.lastName || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Reparto</label>
                        <input type="text" value="${userState.userData.unit || ''}" readonly class="doc-field">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea class="doc-field" id="doc-notes"></textarea>
                    </div>
                `;
            }
            
            modalBody.innerHTML = formHtml;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('documentModal').classList.remove('active');
        }

        function saveDocument() {
            userState.documents[currentDocument] = {
                completed: true,
                timestamp: new Date().toISOString(),
                data: {} // Could collect form data here
            };
            
            userState.userData.documents = userState.documents;
            updateAdminState();
            closeModal();
            updateDocuments();
            updateUI();
            
            alert('Documento salvato e firmato');
        }

        function submitAllDocuments() {
            if (!userState.signature) {
                alert('Configura prima la tua firma digitale');
                showSection('signature', document.querySelector('.nav-link[onclick*=signature]'));
                return;
            }
            
            const docsCount = Object.keys(userState.documents).length;
            const requiredDocs = 6;
            
            if (docsCount < requiredDocs) {
                alert(`Completa tutti i documenti (${docsCount}/${requiredDocs} completati)`);
                return;
            }
            
            if (!sharedConfig.config?.serviceId) {
                alert('Il sistema di invio email non è configurato. Contatta l\'amministratore.');
                return;
            }
            
            // Mark as submitted
            userState.userData.documentsSubmitted = true;
            userState.userData.submittedAt = new Date().toISOString();
            updateAdminState();
            
            // Send email via EmailJS
            const emailParams = {
                to_email: sharedConfig.config.recipientEmail,
                from_name: `${userState.userData.rank} ${userState.userData.lastName}`,
                from_email: userState.userData.email,
                subject: `Documenti F-35 Training - ${userState.userData.lastName}`,
                message: `
                    Documenti firmati ricevuti da:
                    ${userState.userData.rank} ${userState.userData.firstName} ${userState.userData.lastName}
                    
                    Forza Armata: ${userState.userData.service}
                    Reparto: ${userState.userData.unit}
                    Corso: ${userState.userData.course}
                    Periodo: ${userState.userData.arrivalDate} - ${userState.userData.departureDate}
                    
                    Tutti i documenti sono stati compilati e firmati digitalmente.
                `
            };
            
            emailjs.send(
                sharedConfig.config.serviceId,
                sharedConfig.config.templateId,
                emailParams
            ).then(() => {
                alert('Documenti inviati con successo!');
            }, (error) => {
                alert('Documenti salvati. Verranno inviati appena possibile.');
            });
        }

        // Update UI
        function updateUI() {
            // Update user info
            if (userState.userData.firstName) {
                document.getElementById('userName').textContent = 
                    `${userState.userData.rank || ''} ${userState.userData.firstName} ${userState.userData.lastName}`;
                document.getElementById('userRole').textContent = 
                    `${userState.userData.service || ''} - ${userState.userData.course || ''}`;
            }
            
            // Restore form values
            Object.keys(userState.userData).forEach(key => {
                const element = document.getElementById(key);
                if (element && element.tagName !== 'DIV') {
                    element.value = userState.userData[key];
                }
            });
            
            // Update signature
            if (userState.signature) {
                document.getElementById('savedSignature').style.display = 'block';
                document.getElementById('signatureImage').src = userState.signature;
            }
            
            // Update documents
            updateDocuments();
            
            // Update room
            if (userState.room) {
                document.getElementById('noRoom').style.display = 'none';
                document.getElementById('roomAssigned').style.display = 'block';
                
                document.getElementById('roomBuilding').textContent = userState.room.building;
                document.getElementById('roomNumber').textContent = userState.room.number;
                document.getElementById('roomBed').textContent = userState.room.bed;
                document.getElementById('roomCheckin').textContent = userState.userData.arrivalDate || '--';
                document.getElementById('roomCheckout').textContent = userState.userData.departureDate || '--';
                document.getElementById('roomAddress').textContent = userState.room.address || 'Indirizzo da confermare';
                
                // Generate QR Code
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: `${userState.accessCode}-${userState.room.number}`,
                    width: 200,
                    height: 200
                });
            }
            
            // Update progress
            updateProgress();
        }

        function updateProgress() {
            const checklist = [
                { label: 'Dati Personali', complete: !!userState.userData.email },
                { label: 'Firma Digitale', complete: !!userState.signature },
                { label: 'Documenti BCBS', complete: !!userState.documents.BCBS },
                { label: 'Documenti Responsabilità', complete: !!userState.documents.LIABILITY },
                { label: 'Documenti Security', complete: !!userState.documents.SECURITY },
                { label: 'Documenti Housing', complete: !!userState.documents.HOUSING },
                { label: 'Alloggio Assegnato', complete: !!userState.room }
            ];
            
            const completed = checklist.filter(item => item.complete).length;
            const percentage = Math.round((completed / checklist.length) * 100);
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
            
            document.getElementById('checklistContainer').innerHTML = checklist.map(item => `
                <div class="checklist-item">
                    <div class="checklist-icon ${item.complete ? 'complete' : 'pending'}">
                        ${item.complete ? '✓' : ''}
                    </div>
                    <div class="checklist-label">
                        ${item.label}
                    </div>
                </div>
            `).join('');
        }

        function updateAdminState() {
            let adminState = JSON.parse(localStorage.getItem('f35_admin_state') || '{}');
            const accessCode = adminState.accessCodes?.find(ac => ac.code === userState.accessCode);
            
            if (accessCode) {
                accessCode.used = true;
                accessCode.userId = accessCode.userId || 'USER-' + Date.now();
                accessCode.userData = userState.userData;
                
                localStorage.setItem('f35_admin_state', JSON.stringify(adminState));
                sessionStorage.setItem('f35_session', JSON.stringify(userState));
                
                // Queue update for admin
                const updates = JSON.parse(localStorage.getItem('f35_user_updates') || '[]');
                updates.push({
                    code: userState.accessCode,
                    userId: accessCode.userId,
                    userData: userState.userData,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('f35_user_updates', JSON.stringify(updates));
            }
        }

        function openMap() {
            if (userState.room?.address) {
                window.open(`https://maps.google.com/?q=${encodeURIComponent(userState.room.address)}`, '_blank');
            }
        }

        // Check for room updates
        setInterval(() => {
            if (!userState.accessCode) return;
            
            const adminState = JSON.parse(localStorage.getItem('f35_admin_state') || '{}');
            const accessCode = adminState.accessCodes?.find(ac => ac.code === userState.accessCode);
            
            if (accessCode?.userId) {
                const room = adminState.rooms?.find(r => r.userId === accessCode.userId);
                if (room && !userState.room) {
                    userState.room = room;
                    updateUI();
                    alert('Ti è stato assegnato un alloggio! Controlla la sezione Alloggio.');
                }
            }
        }, 10000);
    </script>
</body>
</html>
