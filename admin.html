<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F-35 Admin Panel - Gestione Sistema</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f1f5f9;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: var(--dark);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 20px 30px;
            background: none;
            border: none;
            color: var(--dark);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            background: white;
        }

        .tab.active {
            background: white;
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .document-builder {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            background: #f8fafc;
        }

        .field-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .field-config {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #86efac;
        }

        .user-list-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .user-list-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2em;
        }

        .user-details h4 {
            margin-bottom: 5px;
            color: var(--dark);
        }

        .user-details p {
            color: #64748b;
            font-size: 0.9em;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .code-editor {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üõ°Ô∏è</span>
                F-35 TMS Admin Panel
            </h1>
            <div>
                <span id="currentTime"></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('users')">üë• Utenti</button>
            <button class="tab" onclick="showTab('rooms')">üè® Alloggi</button>
            <button class="tab" onclick="showTab('documents')">üìÑ Moduli</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Configurazione</button>
            <button class="tab" onclick="showTab('access')">üîê Accessi</button>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <section class="section active" id="dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Utenti Registrati</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="stat-value" id="completedDocs">0</div>
                        <div class="stat-label">Documenti Completati</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <div class="stat-value" id="assignedRooms">0</div>
                        <div class="stat-label">Alloggi Assegnati</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <div class="stat-value" id="pendingActions">0</div>
                        <div class="stat-label">Azioni in Sospeso</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">üìã Attivit√† Recenti</h3>
                    <div id="recentActivity">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Users Management -->
            <section class="section" id="users">
                <div class="card">
                    <h3 class="card-title">üë• Gestione Utenti</h3>
                    
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Ogni utente ha un codice di accesso univoco per visualizzare solo i propri dati
                    </div>

                    <button class="btn btn-primary" onclick="generateAccessCode()">
                        ‚ûï Genera Nuovo Codice Accesso
                    </button>

                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 15px;">Utenti Registrati</h4>
                        <div id="usersList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Room Management -->
            <section class="section" id="rooms">
                <div class="card">
                    <h3 class="card-title">üè® Gestione Alloggi</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>Seleziona Utente</label>
                            <select id="userSelect">
                                <option value="">-- Seleziona --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Building</label>
                            <select id="buildingSelect">
                                <option>Zatitude Apartments</option>
                                <option>Base Housing A</option>
                                <option>Base Housing B</option>
                                <option>Extended Stay Hotel</option>
                                <option>Odom Apartments</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Numero Stanza</label>
                            <input type="text" id="roomNumber" placeholder="Es: 245-B">
                        </div>
                        
                        <div class="form-group">
                            <label>Letto</label>
                            <select id="bedSelect">
                                <option>A</option>
                                <option>B</option>
                                <option>Singola</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Indirizzo</label>
                            <input type="text" id="roomAddress" placeholder="123 Eglin Parkway, Fort Walton Beach, FL">
                        </div>
                        
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" onclick="assignRoom()">
                                ‚úÖ Assegna Alloggio
                            </button>
                        </div>
                    </div>

                    <h4 style="margin: 30px 0 15px;">Alloggi Assegnati</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Utente</th>
                                    <th>Building</th>
                                    <th>Stanza</th>
                                    <th>Letto</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Documents Configuration -->
            <section class="section" id="documents">
                <div class="card">
                    <h3 class="card-title">üìÑ Configurazione Moduli</h3>
                    
                    <div class="document-builder">
                        <h4>Crea Nuovo Modulo</h4>
                        <div class="form-group">
                            <label>Nome Modulo</label>
                            <input type="text" id="docName" placeholder="Es: Dichiarazione COVID">
                        </div>
                        
                        <div class="form-group">
                            <label>Codice</label>
                            <input type="text" id="docCode" placeholder="Es: COVID_FORM">
                        </div>
                        
                        <div class="form-group">
                            <label>Icona</label>
                            <input type="text" id="docIcon" placeholder="Es: ü¶†" maxlength="2">
                        </div>
                        
                        <div class="form-group">
                            <label>Template HTML</label>
                            <div class="code-editor" contenteditable="true" id="docTemplate">
&lt;h3&gt;Titolo Documento&lt;/h3&gt;
&lt;p&gt;Io sottoscritto/a {{firstName}} {{lastName}}, nato/a a {{birthPlace}} il {{birthDate}}&lt;/p&gt;
&lt;p&gt;Dichiaro che...&lt;/p&gt;
&lt;div class="signature-area"&gt;
    &lt;p&gt;Firma: {{signature}}&lt;/p&gt;
    &lt;p&gt;Data: {{currentDate}}&lt;/p&gt;
&lt;/div&gt;
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="addDocument()">
                            ‚ûï Aggiungi Modulo
                        </button>
                    </div>

                    <h4 style="margin: 30px 0 15px;">Moduli Esistenti</h4>
                    <div id="documentsList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Configuration -->
            <section class="section" id="config">
                <div class="card">
                    <h3 class="card-title">‚öôÔ∏è Configurazione Sistema</h3>
                    
                    <h4 style="margin-bottom: 15px;">üìß Email Settings</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>Email Destinatario</label>
                            <input type="email" id="recipientEmail" placeholder="liaison.officer@eglin.af.mil">
                        </div>
                        
                        <div class="form-group">
                            <label>EmailJS Service ID</label>
                            <input type="text" id="serviceId" placeholder="service_xxxxx">
                        </div>
                        
                        <div class="form-group">
                            <label>EmailJS Template ID</label>
                            <input type="text" id="templateId" placeholder="template_xxxxx">
                        </div>
                        
                        <div class="form-group">
                            <label>EmailJS Public Key</label>
                            <input type="text" id="publicKey" placeholder="xxxxxxxxxxxxx">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveConfig()">
                        üíæ Salva Configurazione
                    </button>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h4 style="margin-bottom: 15px;">üîó URL App Utente</h4>
                    <div class="form-group">
                        <label>URL dell'app per i frequentatori</label>
                        <input type="text" id="appUrl" placeholder="https://tuodominio.com/f35-app.html">
                        <small style="color: #64748b;">Questo √® il link che invierai ai frequentatori</small>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h4 style="margin-bottom: 15px;">üíæ Backup & Restore</h4>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-secondary" onclick="exportAll()">
                            üì• Esporta Tutto
                        </button>
                        <button class="btn btn-secondary" onclick="importAll()">
                            üì§ Importa Configurazione
                        </button>
                        <button class="btn btn-danger" onclick="resetSystem()">
                            ‚ö†Ô∏è Reset Sistema
                        </button>
                    </div>
                </div>
            </section>

            <!-- Access Codes -->
            <section class="section" id="access">
                <div class="card">
                    <h3 class="card-title">üîê Codici di Accesso</h3>
                    
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Ogni codice permette l'accesso a un singolo set di dati utente
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateNewCode()">
                        üîë Genera Nuovo Codice
                    </button>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 15px;">Codici Attivi</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Codice</th>
                                        <th>Creato</th>
                                        <th>Usato</th>
                                        <th>Utente</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="accessCodesTable">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Modal</h3>
            <div id="modalBody"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // Admin State
        let adminState = {
            users: [],
            rooms: [],
            documents: [
                { code: 'BCBS', name: 'BCBS Form', icon: 'üè•', template: 'Blue Cross Blue Shield Insurance' },
                { code: 'LIABILITY', name: 'Responsabilit√†', icon: '‚öñÔ∏è', template: 'Dichiarazione di responsabilit√† terzi' },
                { code: 'SECURITY', name: 'Security', icon: 'üîí', template: 'Security briefing acknowledgment' },
                { code: 'HOUSING', name: 'Housing', icon: 'üè†', template: 'Housing agreement' },
                { code: 'VEHICLE', name: 'Vehicle', icon: 'üöó', template: 'Vehicle registration' },
                { code: 'MEDICAL', name: 'Medical', icon: 'üíä', template: 'Medical information' }
            ],
            accessCodes: [],
            config: {
                recipientEmail: 'liaison.officer@eglin.af.mil',
                serviceId: '',
                templateId: '',
                publicKey: '',
                appUrl: ''
            }
        };

        // Load admin state
        function loadAdminState() {
            const saved = localStorage.getItem('f35_admin_state');
            if (saved) {
                adminState = JSON.parse(saved);
                updateAllUI();
            }
        }

        // Save admin state
        function saveAdminState() {
            localStorage.setItem('f35_admin_state', JSON.stringify(adminState));
            // Also save to shared storage for user app
            localStorage.setItem('f35_shared_data', JSON.stringify({
                documents: adminState.documents,
                config: adminState.config
            }));
        }

        // Navigation
        function showTab(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update specific tab content
            if (tabId === 'users') updateUsersList();
            if (tabId === 'rooms') updateRoomsList();
            if (tabId === 'documents') updateDocumentsList();
            if (tabId === 'access') updateAccessCodesList();
        }

        // Generate access code
        function generateNewCode() {
            const code = 'F35-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            const accessCode = {
                code: code,
                created: new Date().toISOString(),
                used: false,
                userId: null,
                userData: null
            };
            
            adminState.accessCodes.push(accessCode);
            saveAdminState();
            updateAccessCodesList();
            
            // Show modal with code
            showModal('Nuovo Codice Generato', `
                <div style="text-align: center; padding: 20px;">
                    <h1 style="font-family: monospace; color: var(--primary); margin: 20px 0;">
                        ${code}
                    </h1>
                    <p>Invia questo codice al frequentatore</p>
                    <p style="margin-top: 15px;">Link completo:</p>
                    <div style="background: var(--light); padding: 10px; border-radius: 8px; margin-top: 10px; word-break: break-all;">
                        ${adminState.config.appUrl}?code=${code}
                    </div>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="copyToClipboard('${adminState.config.appUrl}?code=${code}')">
                        üìã Copia Link
                    </button>
                </div>
            `);
        }

        // Room assignment
        function assignRoom() {
            const userId = document.getElementById('userSelect').value;
            if (!userId) {
                alert('Seleziona un utente');
                return;
            }
            
            const room = {
                userId: userId,
                building: document.getElementById('buildingSelect').value,
                number: document.getElementById('roomNumber').value,
                bed: document.getElementById('bedSelect').value,
                address: document.getElementById('roomAddress').value,
                assigned: new Date().toISOString()
            };
            
            // Remove existing assignment
            adminState.rooms = adminState.rooms.filter(r => r.userId !== userId);
            adminState.rooms.push(room);
            
            // Update user's access code data
            const accessCode = adminState.accessCodes.find(ac => ac.userId === userId);
            if (accessCode && accessCode.userData) {
                accessCode.userData.room = room;
            }
            
            saveAdminState();
            updateRoomsList();
            
            alert('Alloggio assegnato con successo!');
        }

        // Add new document type
        function addDocument() {
            const doc = {
                code: document.getElementById('docCode').value,
                name: document.getElementById('docName').value,
                icon: document.getElementById('docIcon').value || 'üìÑ',
                template: document.getElementById('docTemplate').innerText
            };
            
            if (!doc.code || !doc.name) {
                alert('Compila tutti i campi');
                return;
            }
            
            adminState.documents.push(doc);
            saveAdminState();
            updateDocumentsList();
            
            // Clear form
            document.getElementById('docCode').value = '';
            document.getElementById('docName').value = '';
            document.getElementById('docIcon').value = '';
            document.getElementById('docTemplate').innerText = '';
        }

        // Save configuration
        function saveConfig() {
            adminState.config = {
                recipientEmail: document.getElementById('recipientEmail').value,
                serviceId: document.getElementById('serviceId').value,
                templateId: document.getElementById('templateId').value,
                publicKey: document.getElementById('publicKey').value,
                appUrl: document.getElementById('appUrl').value
            };
            
            saveAdminState();
            alert('Configurazione salvata!');
        }

        // Update UI functions
        function updateAllUI() {
            // Update dashboard stats
            document.getElementById('totalUsers').textContent = adminState.accessCodes.filter(ac => ac.used).length;
            document.getElementById('assignedRooms').textContent = adminState.rooms.length;
            document.getElementById('completedDocs').textContent = adminState.accessCodes
                .filter(ac => ac.userData && ac.userData.documentsCompleted)
                .length;
            document.getElementById('pendingActions').textContent = adminState.accessCodes
                .filter(ac => ac.used && !adminState.rooms.find(r => r.userId === ac.userId))
                .length;
            
            // Update config fields
            if (adminState.config) {
                document.getElementById('recipientEmail').value = adminState.config.recipientEmail || '';
                document.getElementById('serviceId').value = adminState.config.serviceId || '';
                document.getElementById('templateId').value = adminState.config.templateId || '';
                document.getElementById('publicKey').value = adminState.config.publicKey || '';
                document.getElementById('appUrl').value = adminState.config.appUrl || '';
            }
            
            // Update recent activity
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            const activities = [];
            
            // Get recent registrations
            adminState.accessCodes
                .filter(ac => ac.used)
                .slice(-5)
                .forEach(ac => {
                    activities.push({
                        type: 'registration',
                        text: `Nuova registrazione: ${ac.userData?.firstName} ${ac.userData?.lastName}`,
                        time: ac.userData?.registeredAt || ac.created
                    });
                });
            
            // Get recent room assignments
            adminState.rooms.slice(-5).forEach(room => {
                const user = adminState.accessCodes.find(ac => ac.userId === room.userId);
                activities.push({
                    type: 'room',
                    text: `Alloggio assegnato: ${user?.userData?.lastName} - ${room.number}`,
                    time: room.assigned
                });
            });
            
            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            container.innerHTML = activities.slice(0, 10).map(activity => `
                <div style="padding: 10px; border-left: 3px solid var(--primary); margin-bottom: 10px;">
                    <p>${activity.text}</p>
                    <small style="color: #64748b;">${new Date(activity.time).toLocaleString('it-IT')}</small>
                </div>
            `).join('') || '<p style="color: #64748b;">Nessuna attivit√† recente</p>';
        }

        function updateUsersList() {
            const container = document.getElementById('usersList');
            const select = document.getElementById('userSelect');
            
            const users = adminState.accessCodes.filter(ac => ac.used);
            
            select.innerHTML = '<option value="">-- Seleziona --</option>' + 
                users.map(ac => `
                    <option value="${ac.userId}">
                        ${ac.userData?.rank} ${ac.userData?.firstName} ${ac.userData?.lastName}
                    </option>
                `).join('');
            
            container.innerHTML = users.map(ac => `
                <div class="user-list-item">
                    <div class="user-info">
                        <div class="user-avatar">
                            ${ac.userData?.firstName?.[0]}${ac.userData?.lastName?.[0]}
                        </div>
                        <div class="user-details">
                            <h4>${ac.userData?.rank} ${ac.userData?.firstName} ${ac.userData?.lastName}</h4>
                            <p>${ac.userData?.service} - ${ac.userData?.unit}</p>
                            <p>Corso: ${ac.userData?.course}</p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        ${adminState.rooms.find(r => r.userId === ac.userId) 
                            ? '<span class="status-badge status-active">Alloggio Assegnato</span>'
                            : '<span class="status-badge status-pending">In Attesa</span>'}
                    </div>
                </div>
            `).join('') || '<p style="color: #64748b;">Nessun utente registrato</p>';
        }

        function updateRoomsList() {
            const tbody = document.getElementById('roomsTable');
            
            tbody.innerHTML = adminState.rooms.map(room => {
                const user = adminState.accessCodes.find(ac => ac.userId === room.userId);
                return `
                    <tr>
                        <td>${user?.userData?.lastName} ${user?.userData?.firstName}</td>
                        <td>${room.building}</td>
                        <td>${room.number}</td>
                        <td>${room.bed}</td>
                        <td>${user?.userData?.arrivalDate || '-'}</td>
                        <td>${user?.userData?.departureDate || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeRoom('${room.userId}')">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="7" style="text-align: center;">Nessun alloggio assegnato</td></tr>';
        }

        function updateDocumentsList() {
            const container = document.getElementById('documentsList');
            
            container.innerHTML = adminState.documents.map((doc, index) => `
                <div class="field-item">
                    <div>
                        <strong>${doc.icon} ${doc.name}</strong> (${doc.code})
                    </div>
                    <button class="btn btn-danger" onclick="removeDocument(${index})">
                        Rimuovi
                    </button>
                </div>
            `).join('');
        }

        function updateAccessCodesList() {
            const tbody = document.getElementById('accessCodesTable');
            
            tbody.innerHTML = adminState.accessCodes.map(ac => `
                <tr>
                    <td style="font-family: monospace;">${ac.code}</td>
                    <td>${new Date(ac.created).toLocaleDateString('it-IT')}</td>
                    <td>${ac.used ? '‚úÖ' : '‚ùå'}</td>
                    <td>${ac.userData ? `${ac.userData.firstName} ${ac.userData.lastName}` : '-'}</td>
                    <td>
                        <span class="status-badge ${ac.used ? 'status-active' : 'status-pending'}">
                            ${ac.used ? 'Utilizzato' : 'Non utilizzato'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="copyCode('${ac.code}')">
                            üìã
                        </button>
                        <button class="btn btn-danger" onclick="deleteCode('${ac.code}')">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" style="text-align: center;">Nessun codice generato</td></tr>';
        }

        // Utility functions
        function removeDocument(index) {
            if (confirm('Rimuovere questo modulo?')) {
                adminState.documents.splice(index, 1);
                saveAdminState();
                updateDocumentsList();
            }
        }

        function removeRoom(userId) {
            if (confirm('Rimuovere questa assegnazione?')) {
                adminState.rooms = adminState.rooms.filter(r => r.userId !== userId);
                saveAdminState();
                updateRoomsList();
            }
        }

        function deleteCode(code) {
            if (confirm('Eliminare questo codice?')) {
                adminState.accessCodes = adminState.accessCodes.filter(ac => ac.code !== code);
                saveAdminState();
                updateAccessCodesList();
            }
        }

        function copyCode(code) {
            const url = `${adminState.config.appUrl}?code=${code}`;
            copyToClipboard(url);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copiato negli appunti!');
            });
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Export/Import
        function exportAll() {
            const dataStr = JSON.stringify(adminState, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `f35_admin_backup_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importAll() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        adminState = JSON.parse(event.target.result);
                        saveAdminState();
                        updateAllUI();
                        alert('Import completato!');
                    } catch (error) {
                        alert('File non valido');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function resetSystem() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questo canceller√† TUTTI i dati. Sei sicuro?')) {
                if (confirm('Seconda conferma: Tutti i dati verranno PERSI. Continuare?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // Clock
        function updateClock() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleString('it-IT');
        }
        setInterval(updateClock, 1000);

        // Initialize
        window.addEventListener('load', () => {
            loadAdminState();
            updateClock();
        });

        // Auto-sync with user app
        setInterval(() => {
            // Check for updates from user app
            const userUpdates = localStorage.getItem('f35_user_updates');
            if (userUpdates) {
                const updates = JSON.parse(userUpdates);
                
                // Process updates
                updates.forEach(update => {
                    const accessCode = adminState.accessCodes.find(ac => ac.code === update.code);
                    if (accessCode) {
                        accessCode.used = true;
                        accessCode.userId = update.userId;
                        accessCode.userData = update.userData;
                    }
                });
                
                localStorage.removeItem('f35_user_updates');
                saveAdminState();
                updateAllUI();
            }
        }, 5000);
    </script>
</body>
</html>
